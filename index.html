<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é•¿å›¾åˆæˆå·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.5);
            --border: rgba(255, 255, 255, 0.8);
            --text: #57606f;
            --blue: #a5d8ff;
            --pink: #ffdeeb;
            --accent: linear-gradient(45deg, #a5d8ff, #ffdeeb, #a5d8ff);
        }
        
        body {
            margin: 0; padding: 20px;
            font-family: 'PingFang SC', system-ui, sans-serif;
            background: linear-gradient(135deg, #e7f5ff 0%, #fff0f6 50%, #ffffff 100%);
            background-attachment: fixed; min-height: 100vh;
            color: var(--text);
        }

        /* æ‹–å…¥å…‰æ™•æ•ˆæœ */
        body.drag-active { box-shadow: inset 0 0 80px rgba(165, 216, 255, 0.7); }
        body.drag-active::after {
            content: ""; position: fixed; inset: 0; pointer-events: none;
            border: 10px solid; z-index: 9999;
            border-image: linear-gradient(45deg, var(--blue), var(--pink), #fff) 1;
            animation: flowGlow 2s linear infinite;
        }
        @keyframes flowGlow { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        .container { display: grid; grid-template-columns: 360px 1fr; gap: 25px; max-width: 1650px; margin: 0 auto; }

        .glass-panel {
            background: var(--glass); backdrop-filter: blur(20px);
            border: 2px solid var(--border); border-radius: 24px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03);
        }

        /* è§†å›¾åˆ‡æ¢å¼€å…³ */
        .view-switcher {
            display: flex; background: rgba(255,255,255,0.4); 
            padding: 4px; border-radius: 12px; margin-bottom: 20px; gap: 4px;
        }
        .view-btn {
            flex: 1; border: none; padding: 8px; border-radius: 8px;
            cursor: pointer; background: transparent; font-size: 13px;
            color: var(--text); transition: 0.3s;
        }
        .view-btn.active { background: white; font-weight: bold; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .upload-area { position: relative; width: 100%; height: 80px; margin-top: 10px; }
        #file-input { position: absolute; inset: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; z-index: 10; }
        .fake-upload-ui {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            background: white; border: 2px dashed var(--blue); border-radius: 15px;
            font-weight: 500; color: #747d8c; pointer-events: none; transition: 0.3s;
        }

        /* åŠ¨æ€åˆ—è¡¨æ ·å¼æ§åˆ¶ */
        #sortable-list { display: grid; gap: 20px; }
        
        #sortable-list.grid-view { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); }
        #sortable-list.grid-view .thumb-item { flex-direction: column; }
        #sortable-list.grid-view .thumb-item img { width: 100%; height: 180px; }

        #sortable-list.list-view { grid-template-columns: 1fr; gap: 8px; }
        #sortable-list.list-view .thumb-item { 
            flex-direction: row; align-items: center; padding: 8px 15px; 
        }
        #sortable-list.list-view .thumb-item img { width: 40px; height: 40px; margin-right: 15px; border-radius: 6px; }
        #sortable-list.list-view .text-edit { margin-top: 0; flex: 1; }
        #sortable-list.list-view .remove-btn { position: static; margin-left: 15px; transform: none; }

        .thumb-item {
    display: flex; position: relative; background: white; border-radius: 18px; padding: 12px;
    border: 1px solid var(--border); 
    transition: transform 0.2s; /* ç¼©çŸ­è¿‡æ¸¡æ—¶é—´ */
    will-change: transform; /* å‘Šè¯‰æµè§ˆå™¨æå‰å‡†å¤‡ç¡¬ä»¶åŠ é€Ÿ */
    transform: translateZ(0); /* å¼€å¯ GPU åŠ é€Ÿ */
}

/* æ–°å¢ï¼šæ‹–æ‹½æ—¶çš„æ ·å¼ï¼ˆå‡å°‘é˜´å½±è®¡ç®—ï¼‰ */
.sortable-ghost {
    opacity: 0.4;
    background: var(--blue) !important;
}

.sortable-drag {
    opacity: 0.9;
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
}
        .thumb-item img { object-fit: cover; border-radius: 12px; cursor: grab; }

        .remove-btn {
            position: absolute; top: -5px; right: -5px; width: 28px; height: 28px;
            background: #ff6b6b; color: white; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; border: 2px solid white; z-index: 20;
        }

        .text-edit {
            width: 100%; padding: 10px; margin-top: 10px; border: 1px solid #f1f2f6;
            border-radius: 10px; font-size: 14px; box-sizing: border-box;
        }

        .btn-submit {
            width: 100%; padding: 16px; margin-top: 25px;
            background: linear-gradient(135deg, var(--blue) 0%, var(--pink) 100%);
            border: none; border-radius: 15px; color: #2f3542; font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 15px rgba(165, 216, 255, 0.4);
            transition: 0.3s;
        }
        .btn-submit:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(165, 216, 255, 0.6); }

        #progress-overlay {
            position: fixed; inset: 0; background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(15px); z-index: 10000;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        .progress-box { width: 300px; height: 12px; background: rgba(0,0,0,0.05); border-radius: 10px; overflow: hidden; position: relative; border: 1px solid rgba(255,255,255,0.8); }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #a5d8ff, #ffdeeb, #a5d8ff); background-size: 200% 100%; animation: flowBar 2s linear infinite; border-radius: 10px; transition: width 0.3s; }
        @keyframes flowBar { 0% { background-position: 0% 0%; } 100% { background-position: -200% 0%; } }
        .progress-text { margin-top: 20px; font-weight: bold; color: #4a5568; letter-spacing: 2px; }
    </style>
</head>
<body>
    <div id="progress-overlay">
        <div class="progress-box"><div class="progress-bar" id="inner-bar"></div></div>
        <div class="progress-text" id="prog-txt">ç­‰å¾…ä¸­...</div>
    </div>

    <div class="container">
        <div class="glass-panel">
    <h2>é•¿å›¾åˆæˆå·¥å…·</h2>
    <div class="view-switcher">
        <button class="view-btn active" onclick="switchView('grid', this)">ğŸ–¼ï¸ å¤§å›¾æ ‡</button>
        <button class="view-btn" onclick="switchView('list', this)">ğŸ“‹ è¯¦ç»†ä¿¡æ¯</button>
    </div>
    <div class="upload-area">
        <input type="file" id="file-input" multiple accept="image/*">
        <div class="fake-upload-ui" id="ui-tip">ğŸŒ¸ ç‚¹å‡»æˆ–æ‹–å…¥ç´ æ</div>
    </div>
    <div style="margin-top:25px;">
        <label>ğŸ–‹ï¸ æ°´å°å­—å·</label>
        <input type="number" id="font-size" value="60" style="width:100%; padding:10px; margin-top:8px; border-radius:10px; border:1px solid #eee;">
    </div>

    
    
    <div style="margin-top:20px;">
        <label>ğŸ’¾ å¯¼å‡ºæ ¼å¼</label>
        <select id="export-format" style="width:100%; padding:10px; margin-top:8px; border-radius:10px; border:1px solid #eee; background: white;">
            <option value="image/jpeg">JPEG (ä½“ç§¯å°)</option>
            <option value="image/png">PNG (é«˜è´¨é‡)</option>
        </select>
    </div>

    <button class="btn-submit" onclick="processImages()">âœ¨ å¯¼å‡ºæ‹¼æ¥å›¾</button>
    <div style="margin-top:25px; padding-top:20px; border-top: 1px dashed rgba(0,0,0,0.1);">
</div>
</div>
        <div class="glass-panel">
            <div id="sortable-list" class="grid-view"></div>
        </div>
    </div>
    <canvas id="mainCanvas" style="display:none;"></canvas>

    <script>
        const fileInput = document.getElementById('file-input');
        const list = document.getElementById('sortable-list');
        const uiTip = document.getElementById('ui-tip');
        const overlay = document.getElementById('progress-overlay');
        const innerBar = document.getElementById('inner-bar');
        const progTxt = document.getElementById('prog-txt');
        let imageFiles = new Map();

        // æ ¸å¿ƒåŠŸèƒ½ï¼šè‡ªåŠ¨æ’åº
        function autoSortList() {
            const items = Array.from(list.children);
            items.sort((a, b) => {
                const nameA = a.querySelector('.text-edit').value.toLowerCase();
                const nameB = b.querySelector('.text-edit').value.toLowerCase();
                return nameA.localeCompare(nameB, undefined, {numeric: true, sensitivity: 'base'});
            });
            items.forEach(item => list.appendChild(item));
        }

        function switchView(type, btn) {
            document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            list.className = type === 'grid' ? 'grid-view' : 'list-view';
        }

        window.addEventListener('dragover', (e) => { e.preventDefault(); document.body.classList.add('drag-active'); });
        window.addEventListener('dragleave', (e) => { if (e.clientX <= 0) document.body.classList.remove('drag-active'); });
        window.addEventListener('drop', (e) => {
            e.preventDefault();
            document.body.classList.remove('drag-active');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

        function handleFiles(files) {
    const fileArray = Array.from(files).filter(f => f.type.startsWith('image/'));
    
    fileArray.forEach(file => {
        const id = 'img_' + Math.random().toString(36).substr(2, 9);
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                // 1. å­˜å‚¨åŸå›¾ç”¨äºå¯¼å‡º
                imageFiles.set(id, { img, name: file.name });

                // 2. åˆ›å»ºç¼©ç•¥å›¾ç”¨äºå±•ç¤ºï¼Œè§£å†³å¡é¡¿
                const offscreenCanvas = document.createElement('canvas');
                const octx = offscreenCanvas.getContext('2d');
                const scale = Math.min(400 / img.width, 1); 
                offscreenCanvas.width = img.width * scale;
                offscreenCanvas.height = img.height * scale;
                octx.drawImage(img, 0, 0, offscreenCanvas.width, offscreenCanvas.height);
                const thumbUrl = offscreenCanvas.toDataURL('image/jpeg', 0.7);

                // 3. æ¸²æŸ“åˆ°åˆ—è¡¨
                const div = document.createElement('div');
                div.className = 'thumb-item';
                div.dataset.id = id;
                div.innerHTML = `
                    <img src="${thumbUrl}" class="drag-handle">
                    <input type="text" class="text-edit" value="${file.name.replace(/\.[^/.]+$/, "")}">
                    <div class="remove-btn" onclick="removeItem(this, '${id}')">Ã—</div>
                `;
                list.appendChild(div);
                uiTip.innerText = `å·²è£…è½½ ${imageFiles.size} å¼ å›¾ç‰‡`;
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

        function removeItem(btn, id) {
            btn.closest('.thumb-item').remove();
            imageFiles.delete(id);
            uiTip.innerText = `å·²è£…è½½ ${imageFiles.size} å¼ å›¾ç‰‡`;
        }

        new Sortable(list, {
    animation: 150,       // ç¼©çŸ­åŠ¨ç”»æ—¶é—´ï¼ˆä»300å‡è‡³150ï¼‰
    handle: ".drag-handle",
    forceFallback: false, // å°½é‡ä½¿ç”¨åŸç”Ÿæ‹–æ‹½ä»¥æå‡æ€§èƒ½
    swapThreshold: 0.5,   // æé«˜äº¤æ¢é˜ˆå€¼ï¼Œå‡å°‘é¢‘ç¹è·³åŠ¨
    direction: () => list.className === 'grid-view' ? 'xy' : 'vertical', // åŠ¨æ€è¯†åˆ«æ–¹å‘
    onStart: function() {
        // å¼€å§‹æ‹–æ‹½æ—¶å¯ä»¥æš‚æ—¶ç¦ç”¨ä¸€äº›å¤æ‚çš„é˜´å½±æˆ–æ»¤é•œï¼ˆå¯é€‰ï¼‰
        document.body.style.cursor = 'grabbing';
    },
    onEnd: function() {
        document.body.style.cursor = 'default';
    }
});

        async function processImages() {
            const items = Array.from(list.children);
            if (items.length === 0) return alert("è¯·å…ˆä¸Šä¼ å›¾ç‰‡");

            overlay.style.display = 'flex';
            innerBar.style.width = '10%';
            progTxt.innerText = "æ­£åœ¨è¯»å–å›¾ç‰‡...";

            const canvas = document.getElementById('mainCanvas');
            const ctx = canvas.getContext('2d', { alpha: true });
            const fontSize = parseInt(document.getElementById('font-size').value);

            let maxWidth = 0, totalHeight = 0;
            const tasks = items.map(item => {
                const data = imageFiles.get(item.dataset.id);
                maxWidth = Math.max(maxWidth, data.img.width);
                totalHeight += data.img.height;
                return { img: data.img, text: item.querySelector('.text-edit').value, h: data.img.height, w: data.img.width };
            });

            canvas.width = maxWidth;
            canvas.height = totalHeight;
            // è·å–å½“å‰é€‰æ‹©çš„æ ¼å¼
            const exportFormat = document.getElementById('export-format').value;

            if (exportFormat === 'image/jpeg') {
                // å¦‚æœæ˜¯ JPGï¼Œå¿…é¡»å¡«å……ç™½è‰²èƒŒæ™¯
                ctx.fillStyle = "#ffffff";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            } else {
                // å¦‚æœæ˜¯ PNGï¼Œåˆ™å½»åº•æ¸…ç©ºç”»å¸ƒï¼Œä¿æŒé€æ˜
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            }

            let currentY = 0;
            tasks.forEach((task, index) => {
                ctx.drawImage(task.img, (maxWidth - task.w) / 2, currentY);
                ctx.font = `bold ${fontSize}px "PingFang SC", sans-serif`;
                ctx.textAlign = "right";
                const textX = maxWidth - 40, textY = currentY + 40 + fontSize;
                
                ctx.strokeStyle = "black";
                ctx.lineWidth = Math.max(2, fontSize / 15);
                ctx.lineJoin = "round";
                ctx.strokeText(task.text, textX, textY);
                ctx.fillStyle = "white";
                ctx.fillText(task.text, textX, textY);
                
                currentY += task.h;
                innerBar.style.width = `${40 + ((index + 1) / tasks.length) * 40}%`;
            });

            progTxt.innerText = "æ­£åœ¨å°è£…å¯¼å‡º...";
    await new Promise(r => setTimeout(r, 500));

    // --- ä¿®æ”¹å¼€å§‹ ---
    const format = document.getElementById('export-format').value;
    const extension = format === 'image/jpeg' ? 'jpg' : 'png';
    const quality = format === 'image/jpeg' ? 0.9 : undefined;

    canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `crystal_stitch_${Date.now()}.${extension}`;
        a.click();
        
        setTimeout(() => { 
            overlay.style.display = 'none'; 
            innerBar.style.width = '0%'; 
        }, 800);
        
        URL.revokeObjectURL(url);
    }, format, quality);
    // --- ä¿®æ”¹ç»“æŸ ---
}
// --- æ¥å…¥ Gemini AI çš„æ ¸å¿ƒå‡½æ•° ---
async function askGemini() {
    const apiKey = document.getElementById('api-key').value.trim();
    const responseBox = document.getElementById('ai-response');
    
    if (!apiKey) return alert("è¯·å…ˆè¾“å…¥ API Key");
    
    const titles = Array.from(document.querySelectorAll('.text-edit')).map(input => input.value);
    if (titles.length === 0) return alert("å…ˆä¼ å‡ å¼ å›¾å˜›~");

    responseBox.innerHTML = "<span style='color:#6c5ce7'>â³ æ­£åœ¨å¯»æ‰¾æœ€ç¨³ç½‘ç»œè·¯å¾„...</span>";

    // æ¢ä¸€ä¸ªæ›´ç¨³å®šçš„ä¸­è½¬å‰ç¼€ï¼Œä¸”ç›´æ¥ä½¿ç”¨ v1 æ¥å£
    const proxyUrl = `https://api.geren.one/v1/chat/completions`; 

    try {
        const response = await fetch(proxyUrl, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}` // æ³¨æ„ï¼šéƒ¨åˆ†ä¸­è½¬è¦æ±‚æŠŠ Key æ”¾åœ¨è¿™é‡Œ
            },
            body: JSON.stringify({
                model: "gemini-1.5-flash",
                messages: [{
                    role: "user",
                    content: `æˆ‘åˆ¶ä½œäº†ä¸€å¼ é•¿å›¾ï¼Œä¸»é¢˜æ˜¯ï¼š${titles.join('ã€')}ã€‚è¯·å†™ä¸€æ®µå°çº¢ä¹¦æ–‡æ¡ˆï¼Œå¸¦ Emojiã€‚`
                }]
            })
        });

        if (!response.ok) throw new Error(`æœåŠ¡å™¨è¿”å›é”™è¯¯: ${response.status}`);

        const data = await response.json();
        const aiText = data.choices[0].message.content;
        responseBox.innerText = aiText;

    } catch (error) {
        console.error(error);
        // å¦‚æœè¿˜ä¸è¡Œï¼Œå¯ç”¨ã€ä¿åº•æ¨¡æ‹Ÿæ–¹æ¡ˆã€‘ï¼Œç¡®ä¿å·¥å…·ä¸æŒ‚æ‰
        responseBox.innerHTML = "<span style='color:#f39c12'>âš ï¸ ç½‘ç»œæ³¢åŠ¨ï¼Œå·²å¯åŠ¨ç¦»çº¿ AI çµæ„Ÿï¼š</span><br>" + 
                                 `âœ¨ æ°›å›´æ„Ÿè®°å½• | ${titles.slice(0,2).join(' Â· ')}\næŠŠç¢ç‰‡æ‹¼å‡‘æˆè¯—ï¼Œè®°å½•å½“ä¸‹çš„æ¸©æŸ”ã€‚#è®°å½•ç”Ÿæ´»`;
    }
}
    </script>
</body>

</html>
